name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "postgresql://postgres:password@localhost:5432/napgram?schema=public"
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      MARKETPLACE_PR_TOKEN: ${{ secrets.MARKETPLACE_PR_TOKEN }}
      PUBLISH_COOLDOWN_MINUTES: "10"
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          registry-url: https://registry.npmjs.org/
          always-auth: true
      - run: pnpm i
      - run: pnpm prisma generate
      - run: pnpm validate
      - name: Check publish window
        run: |
          node --input-type=module <<'NODE'
          import fs from 'fs';
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const name = pkg.name;
          const version = pkg.version;
          const cooldown = Number(process.env.PUBLISH_COOLDOWN_MINUTES || '10');
          if (!Number.isFinite(cooldown) || cooldown <= 0) {
            console.log('Publish cooldown disabled');
            process.exit(0);
          }
          const res = await fetch(`https://registry.npmjs.org/${encodeURIComponent(name)}`);
          if (res.status === 404) {
            console.log('Package not found on registry; skip cooldown check');
            process.exit(0);
          }
          if (!res.ok) {
            throw new Error(`Registry request failed: ${res.status}`);
          }
          const data = await res.json();
          if (data?.versions?.[version]) {
            console.error(`Version ${version} already published for ${name}`);
            process.exit(1);
          }
          const versionCount = data?.versions ? Object.keys(data.versions).length : 0;
          if (versionCount <= 1) {
            console.log('Only one version on registry; skip cooldown check');
            process.exit(0);
          }
          const time = data?.time || {};
          const ignore = new Set(['created', 'modified']);
          const dates = Object.entries(time)
            .filter(([key]) => !ignore.has(key))
            .map(([, value]) => new Date(value))
            .filter((date) => !Number.isNaN(date.valueOf()));
          if (!dates.length) {
            console.log('No publish timestamps found');
            process.exit(0);
          }
          const last = new Date(Math.max(...dates.map((date) => date.valueOf())));
          const ageMinutes = (Date.now() - last.getTime()) / 60000;
          if (ageMinutes < cooldown) {
            console.error(`Last publish was ${ageMinutes.toFixed(1)} minutes ago; cooldown is ${cooldown} minutes`);
            process.exit(1);
          }
          console.log('Publish window ok');
          NODE
      - run: pnpm pack:zip
      - run: pnpm pack:tgz
      - run: pnpm -s marketplace:snippet > marketplace-index-snippet.json
      - id: marketplace-meta
        run: |
          node --input-type=module -e "import fs from 'fs'; const pkg = JSON.parse(fs.readFileSync('package.json','utf8')); const meta = JSON.parse(fs.readFileSync('napgram-plugin.json','utf8')); const id = (meta.id || pkg.name); console.log('id=' + id); console.log('version=' + pkg.version);" >> $GITHUB_OUTPUT
      - if: ${{ env.MARKETPLACE_PR_TOKEN != '' }}
        name: Ensure marketplace fork
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.MARKETPLACE_PR_TOKEN }}
          script: |
            const upstream = { owner: 'NapGram', repo: 'marketplace' };
            const forkOwner = context.actor;
            try {
              await github.rest.repos.get({ owner: forkOwner, repo: upstream.repo });
              return;
            } catch (error) {
              if (error.status !== 404) throw error;
            }
            await github.rest.repos.createFork({ owner: upstream.owner, repo: upstream.repo });
            for (let i = 0; i < 10; i++) {
              try {
                await github.rest.repos.get({ owner: forkOwner, repo: upstream.repo });
                return;
              } catch {
                await new Promise(resolve => setTimeout(resolve, 3000));
              }
            }
            core.setFailed('marketplace fork not ready');
      - if: ${{ env.MARKETPLACE_PR_TOKEN != '' }}
        name: Check marketplace workflow access
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.MARKETPLACE_PR_TOKEN }}
          script: |
            const forkOwner = context.actor;
            const repo = 'marketplace';
            const path = '.github/workflows/validate-pr.yml';
            try {
              await github.rest.repos.getContent({ owner: forkOwner, repo, path });
              return;
            } catch (error) {
              if (error.status === 404) {
                core.setFailed('Marketplace fork missing .github/workflows/validate-pr.yml. Sync the fork or use a token with workflow scope to allow pushing workflow files.');
                return;
              }
              throw error;
            }
      - if: ${{ env.MARKETPLACE_PR_TOKEN != '' }}
        uses: actions/checkout@v4
        with:
          repository: NapGram/marketplace
          token: ${{ env.MARKETPLACE_PR_TOKEN }}
          path: marketplace
      - if: ${{ env.MARKETPLACE_PR_TOKEN != '' }}
        run: node scripts/marketplace-upsert.mjs --index marketplace/index.json --snippet marketplace-index-snippet.json
      - if: ${{ env.MARKETPLACE_PR_TOKEN != '' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.MARKETPLACE_PR_TOKEN }}
          path: marketplace
          commit-message: "marketplace: update ${{ steps.marketplace-meta.outputs.id }} ${{ steps.marketplace-meta.outputs.version }}"
          branch: "marketplace/${{ steps.marketplace-meta.outputs.id }}-${{ steps.marketplace-meta.outputs.version }}"
          title: "marketplace: update ${{ steps.marketplace-meta.outputs.id }} ${{ steps.marketplace-meta.outputs.version }}"
          body: "Auto-generated marketplace submission."
          base: main
          push-to-fork: ${{ github.actor }}/marketplace
      - run: pnpm publish --access public --no-git-checks
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
            marketplace-index-snippet.json
